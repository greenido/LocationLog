<!doctype html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <meta name="author" content="Ido Green | greenido.wordpress.com | @greenido">
  <meta name="theme-color" content="#db5945">

  <title>Locations Log</title>
  <link rel="stylesheet" href="css/foundation.css" />
  <!-- TODO: move it from here -->
  <style>
    #map {
      width: calc((100% - 10px));
      height:  300px;
    }
  </style>

  <script src="js/vendor/modernizr.js"></script>
  <script src="https://cdn.firebase.com/js/client/2.3.0/firebase.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js"></script>

</head>

<body>
  <div class="fixed">
    <nav class="top-bar" data-topbar role="navigation">
      <ul class="title-area">
        <li class="name">
          <h1>
            <a href="#">Locations Log</a>
          </h1>
        </li>
        <li class="toggle-topbar menu-icon">
          <a href="#">
            <span></span>
          </a>
        </li>
      </ul>

      <section class="top-bar-section">
        <!-- Left Nav Section -->
        <ul class="left">
          <li>
            <a href="#add" class="alert button">Add</a>
          </li>
          <li class="divider"></li>
          <li>
            <a href="#" class="button">History</a>
          </li>
          <li class="divider"></li>
          <li>
            <a href="#" class="button">Share</a>
          </li>
          <li class="divider"></li>
          <li>
            <a href="#" class="button">Help</a>
          </li>
        </ul>
      </section>
    </nav>
  </div>

  <div class="row">
    <div id="map" class="large-12 columns">Loading map...</div>

    <div id="add" class="large-10 columns">
      <form>
        <fieldset>
          <legend>New Point</legend>
          <div class="large-3 small-8">
            <label>
              Geo Point
              <input id="f-geo-point" type="text" disabled></label>
          </div>

          <label>
            Name
            <input id="f-point-name" type="text" placeholder="Type something that you can remember later..."></label>

          <label>
            Comments
            <textarea id="f-point-comments" placeholder="Anything else..."></textarea>
          </label>

        </fieldset>

        <a href="#" id="cancel-button" class="button round">Cancel</a>
        <a href="#" id="save-button" class="button alert  round">Save It!</a>

      </form>

    </div>

  </div>

  <footer class="row">
    <div class="large-12 columns">
      <hr/>
      <div class="row">
        <div class="large-6 columns">
          <p>Â© Copyright</p>
        </div>
        <div class="large-6 columns">
          <ul class="inline-list right">
            <li>
              <a href="#">Share</a>
            </li>
            <li>
              <a href="#">Help</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </footer>
  <script src="js/vendor/jquery.js"></script>
  <script src="js/foundation.min.js"></script>

  <!-- plugins -->
  <sript src="js/foundation/foundation.topbar.js"></script>

  <script>$(document).foundation();</script>
  <!-- TODO: move it from here to its own file -->
  <script>

      // Create a callback which logs the current auth state
      function authDataCallback(authData) {
        if (authData) {
          console.log("User " + authData.uid + " is logged in with " + authData.provider);
          localStorage.setItem("locationslog-authData", JSON.stringify(authData) );
        } else {
          console.log("User is logged out :(");
            // TODO - alert her to login

          ref.authWithOAuthPopup("google", function(error, authData) {
              if (error) {
                console.log("Login Failed!", error);
                // TODO - show error
              } else {
                console.log("Authenticated successfully with payload:", authData);
                // TODO - show an alert and a sign of login
              }
            });
          
        }
      }
      var ref = new Firebase("https://locationslog.firebaseio.com");  
      ref.onAuth(authDataCallback);
      //
      function initAll() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(initialize, showError);
        } else {
          console.log("Geolocation is not supported by this browser");
          // TODO - show an alert + message to the user


        }

        $("#save-button").click(function () {
          console.log("saving to firebase: " + $("#f-point-name").val() + " , " + 
              $("#f-geo-point").val());
          var authData = JSON.parse(localStorage.getItem("locationslog-authData") );
          var locKey = $("#f-geo-point").val();
          locKey = locKey.replace(/, /g, "|");
          locKey = locKey.replace(/\./g, "-");
          var curUnixTime = new Date().getTime();
          var disTime = new Date().toJSON().slice(0,21);
          ref.child("users").child(authData.uid).child(authData.google.displayName).child(locKey).set({
            unixTime: curUnixTime,
            date: disTime,
            name: $("#f-point-name").val(),
            comments: $("#f-point-comments").val(),
            geolocation: $("#f-geo-point").val()
          
          });
        });
      }

      //
      function initialize(position) {
        var mapCanvas = document.getElementById('map');
        console.log("** Pos: " + position.coords.latitude + ", " + position.coords.longitude);
        $("#f-geo-point").val(position.coords.latitude.toFixed(5) + ", " + position.coords.longitude.toFixed(5));

        var mapOptions = {
          center: new google.maps.LatLng(position.coords.latitude, position.coords.longitude),
          zoom: 12,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        }
        var map = new google.maps.Map(mapCanvas, mapOptions);
        
        // TODO - remove it!
        var htmlForm = '<form id="newpoint"> <div class="input-field col s6"> <label for="location_name" class="" >Name</label> <input id="location_name" type="text" placeholder="Something..." class="validate" required></div> <div class="input-field col s6"><label for="comment" class="">Comment</label><textarea id="comment" form="newpoint" placeholder="Enter comments here..."></textarea></div> </form> <button id="cancelButton">Cancel</button> <button id="saveButton">Save</button>';
        var infowindow = new google.maps.InfoWindow({
          content: "Point: " + htmlForm // + marker.position
        });

        
        //
        var iconBase = 'https://maps.google.com/mapfiles/kml/shapes/';
        var tmpPoint = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
        
        var marker = new google.maps.Marker({
          position: tmpPoint,
          draggable: true,
          title: "Click to edit",
          animation: google.maps.Animation.DROP,
          map: map,
          icon: iconBase + 'schools_maps.png'
        });

        marker.addListener('click', function() {
          infowindow.open(map, marker);
          toggleBounce(marker);
        });

        marker.addListener('mouseup', function(e) {
          //console.log("mouseup: " + JSON.stringify(e));
          $("#f-geo-point").val(e.latLng.H.toFixed(5) + ", " + e.latLng.H.toFixed(5)); 
        });

      }

      //
      function toggleBounce(marker) {
        if (marker.getAnimation() !== null) {
          marker.setAnimation(null);
        } else {
          marker.setAnimation(google.maps.Animation.BOUNCE);
        }
      }

      //
      function showError(error) {
        var x = document.getElementById("map");
        switch (error.code) {
          case error.PERMISSION_DENIED:
            x.innerHTML = "Denied the request for Geolocation. Maybe, ask the user in a more polite way?"
            break;
          case error.POSITION_UNAVAILABLE:
            x.innerHTML = "Location information is unavailable.";
            break;
          case error.TIMEOUT:
            x.innerHTML = "The request to get location timed out.";
            break;
          case error.UNKNOWN_ERROR:
            x.innerHTML = "An unknown error occurred :(";
            break;
        }
      }
      //
      //
      google.maps.event.addDomListener(window, 'load', initAll);

    </script>

  <!-- GA -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53348325-1', 'auto');
    ga('require', 'displayfeatures');
    ga('send', 'pageview');
  </script>

</body>
</html>